apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
- metallb_l2advertisement.yaml
- ocp_networks_netattach.yaml
- ocp_ip_pools.yaml
- netconfig.yaml
- metallb_bgppeers.yaml
- metallb_bgpadvertisements.yaml
#- metallb_bgpextras.yaml

patches:
- target:
    kind: NetworkAttachmentDefinition
    labelSelector: "osp/net-attach-def-type=standard"
  path: ocp_network_template.yaml
- target:
    kind: IPAddressPool
    labelSelector: "osp/lb-addresses-type=standard"
  path: ocp_ip_pool_template.yaml

replacements:
# NetworkAttachmentDefinition JSON config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.net-attach-def
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: ctlplane
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.net-attach-def
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: internalapi
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.net-attach-def
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: storage
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.net-attach-def
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: tenant
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.datacentre.net-attach-def
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: datacentre
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.net-attach-def.node0.bgpnet0
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet-0-0
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.net-attach-def.node0.bgpnet1
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet-0-1
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.net-attach-def.node1.bgpnet0
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet-1-0
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.net-attach-def.node1.bgpnet1
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet-1-1
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.net-attach-def.node2.bgpnet0
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet-2-0
    fieldPaths:
    - spec.config
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.net-attach-def.node2.bgpnet1
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet-2-1
    fieldPaths:
    - spec.config

# IPAddressPool addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.lb_addresses
  targets:
  - select:
      kind: IPAddressPool
      name: ctlplane
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.lb_addresses
  targets:
  - select:
      kind: IPAddressPool
      name: internalapi
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.lb_addresses
  targets:
  - select:
      kind: IPAddressPool
      name: storage
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.lb_addresses
  targets:
  - select:
      kind: IPAddressPool
      name: tenant
    fieldPaths:
    - spec.addresses

# Loadbalancer address pools
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.lb_addresses
  targets:
  - select:
      group: metallb.io
      kind: IPAddressPool
      name: ctlplane
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.lb_addresses
  targets:
  - select:
      group: metallb.io
      kind: IPAddressPool
      name: internalapi
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.lb_addresses
  targets:
  - select:
      group: metallb.io
      kind: IPAddressPool
      name: tenant
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.lb_addresses
  targets:
  - select:
      group: metallb.io
      kind: IPAddressPool
      name: ctlplane
    fieldPaths:
    - spec.addresses
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.lb_addresses
  targets:
  - select:
      group: metallb.io
      kind: IPAddressPool
      name: storage
    fieldPaths:
    - spec.addresses

# Loadbalancer interfaces
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bridgeName
  targets:
  - select:
      group: metallb.io
      kind: L2Advertisement
      name: ctlplane
    fieldPaths:
    - spec.interfaces.0
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.iface
  targets:
  - select:
      group: metallb.io
      kind: L2Advertisement
      name: tenant
    fieldPaths:
    - spec.interfaces.0
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.iface
  targets:
  - select:
      group: metallb.io
      kind: L2Advertisement
      name: storage
    fieldPaths:
    - spec.interfaces.0
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.iface
  targets:
  - select:
      group: metallb.io
      kind: L2Advertisement
      name: internalapi
    fieldPaths:
    - spec.interfaces.0

# NetConfig dnsDomain
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.dnsDomain
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=CtlPlane].dnsDomain
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.dnsDomain
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=InternalApi].dnsDomain
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.dnsDomain
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=External].dnsDomain
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.dnsDomain
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=Storage].dnsDomain
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.dnsDomain
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=Tenant].dnsDomain

# NetConfig MTU
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.mtu
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=CtlPlane].mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.mtu
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=InternalApi].mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.mtu
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=External].mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.mtu
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=Storage].mtu
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.mtu
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=Tenant].mtu

# NetConfig subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.ctlplane.subnets
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=CtlPlane].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.internalapi.subnets
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=InternalApi].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.external.subnets
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=External].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.storage.subnets
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=Storage].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.tenant.subnets
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=Tenant].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.subnets.bgpnet0
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=BgpNet0].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.subnets.bgpnet1
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=BgpNet1].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.subnets.bgpmainnet
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=BgpMainNet].subnets
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.subnets.bgpmainnetv6
  targets:
  - select:
      kind: NetConfig
    fieldPaths:
    - spec.networks.[name=BgpMainNetV6].subnets

# BGP stuff starts with BGPPeer - TODO DOES NOT WORK BECAUSE INTS ARE CHANGED TO STRINGS
#- source:
#    kind: ConfigMap
#    name: network-values
#    fieldPath: data.bgp.asn
#  targets:
#  - select:
#      kind: BGPPeer
#    fieldPaths:
#    - spec.myASN
#- source:
#    kind: ConfigMap
#    name: network-values
#    fieldPath: data.bgp.peer_asn
#  targets:
#  - select:
#      kind: BGPPeer
#    fieldPaths:
#    - spec.peerASN
# BGP router IDs
# node0
# BGP peer IP addresses
# node0
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.bgp_peers.0
  targets:
  - select:
      kind: BGPPeer
      name: bgp-peer-node-0-0
    fieldPaths:
    - spec.peerAddress
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_0.bgp_peers.1
  targets:
  - select:
      kind: BGPPeer
      name: bgp-peer-node-0-1
    fieldPaths:
    - spec.peerAddress
# node1
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.bgp_peers.0
  targets:
  - select:
      kind: BGPPeer
      name: bgp-peer-node-1-0
    fieldPaths:
    - spec.peerAddress
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_1.bgp_peers.1
  targets:
  - select:
      kind: BGPPeer
      name: bgp-peer-node-1-1
    fieldPaths:
    - spec.peerAddress
# node2
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.bgp_peers.0
  targets:
  - select:
      kind: BGPPeer
      name: bgp-peer-node-2-0
    fieldPaths:
    - spec.peerAddress
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.node_2.bgp_peers.1
  targets:
  - select:
      kind: BGPPeer
      name: bgp-peer-node-2-1
    fieldPaths:
    - spec.peerAddress

# BGP Network Attachments
- source:
    kind: ConfigMap
    name: network-values
    fieldPath: data.bgp.ifaces.0
  targets:
  - select:
      kind: NetworkAttachmentDefinition
      name: bgpnet0
    fieldPaths:
    - spec.config
